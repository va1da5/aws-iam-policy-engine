---
name: AWS S3 Access To All Except Few Buckets
description: Create an IAM identity policy that provides **full access** only to the AWS S3 service, but **does not allow modification** of the `acme-service-backups` and `acme-strategic-plans` S3 buckets and the objects inside them.
policyType: IDENTITY_POLICY
initialPolicy:
  {
    "Version": "2012-10-17",
    "Statement": [{ "Effect": "Allow", "Action": "s3:*", "Resource": "*" }],
  }
hints: []
solution: |
  Congratulations! Your created policy should look similar to the below:

  ```json
  {
    "Version": "2012-10-17",
    "Statement": [
      {
        "Effect": "Allow",
        "Action": "s3:*",
        "Resource": "*"
      },
      {
        "Effect": "Deny",
        "Action": [
          "s3:Delete*",
          "s3:Put*"
        ],
        "Resource": [
          "arn:aws:s3:::acme-service-backups",
          "arn:aws:s3:::acme-service-backups/*",
          "arn:aws:s3:::acme-strategic-plans",
          "arn:aws:s3:::acme-strategic-plans/*"
        ]
      }
    ]
  }
  ```

testCases:
  - context:
      action: "${bucketModificationActions}"
      resource: "arn:aws:s3:us-east-1:123456789012:acme-service-backups"
    allow: false

  - context:
      action: "${bucketModificationActions}"
      resource: "arn:aws:s3:us-east-1:123456789012:acme-strategic-plans"
    allow: false

  - context:
      action: "${objectModificationActions}"
      resource: "arn:aws:s3:us-east-1:123456789012:acme-service-backups/customers.sql"
    allow: false

  - context:
      action: "${objectModificationActions}"
      resource: "arn:aws:s3:us-east-1:123456789012:acme-strategic-plans/forecasts.md"
    allow: false

  - context:
      action: "${allowedActionsOnSensitiveBuckets}"
      resource: "arn:aws:s3:us-east-1:123456789012:acme-service-backups"
    allow: true

  - context:
      action: "${allowedActionsOnSensitiveBuckets}"
      resource: "arn:aws:s3:us-east-1:123456789012:acme-strategic-plans"
    allow: true

  - context:
      action: "${allowedActions}"
      resource: "arn:aws:s3:us-east-1:123456789012:acme-generic-files"
    allow: true

  - context:
      action: "${deniedActions}"
      resource: arn:aws:${deniedService}:us-east-1:123456789012:*
    allow: false

values:
  deniedActions:
    - kafka:ListConfigurations
    - apprunner:DeleteObservabilityConfiguration
    - fis:UpdateTargetAccountConfiguration
    - sms-voice:PutProtectConfigurationRuleSetNumberOverride
    - quicksight:DescribeGroupMembership
    - controltower:GetGuardrailComplianceStatus
    - connect:UpdateContactFlowModuleMetadata
    - groundstation:TagResource
    - rds:DescribeDBInstanceAutomatedBackups
    - comprehend:CreateDocumentClassifier
    - servicecatalog:AcceptPortfolioShare
    - personalize:CreateDatasetExportJob
    - lightsail:GetContainerServicePowers
    - mgh:AssociateSourceResource
    - glacier:AddTagsToVault
    - apigateway:SetWebACL
    - ivs:DeletePublicKey
    - lex:ListBotAliases
    - cognito-idp:ListUserPools
    - backup:DescribeBackupVault
    - iot:UpdateCertificate
    - autoscaling:StartInstanceRefresh
    - guardduty:GetUsageStatistics
    - cur:TagResource
    - ec2:ModifyPrivateDnsNameOptions
    - ds:DeleteConditionalForwarder
    - ec2:UnassignIpv6Addresses
    - codewhisperer:ListCustomizationPermissions
    - profile:ListProfileObjectTypeTemplates
    - medialive:UpdateMultiplex
    - sms-voice:PutRegistrationFieldValue
    - qldb:ShowCatalog
    - clouddirectory:ListFacetAttributes
    - route53-recovery-readiness:TagResource
    - shield:ListTagsForResource
    - cognito-sync:SetCognitoEvents
    - globalaccelerator:UpdateCrossAccountAttachment
    - geo-maps:GetStaticMap
    - sagemaker:CreateUserProfile
    - ec2:AssociateTransitGatewayMulticastDomain
    - deeplens:GetAssociatedResources
    - lex:ListTagsForResource
    - codewhisperer:UntagResource
    - identity-sync:DeleteSyncFilter
    - sso:GetPermissionSet
    - license-manager:UpdateServiceSettings
    - rum:PutRumMetricsDestination
    - servicecatalog:AssociateServiceActionWithProvisioningArtifact
    - cognito-idp:AdminDisableProviderForUser
    - ses:CreateTemplate
    - chime:DisassociateChannelFlow
    - cloudfront:GetOriginRequestPolicy
    - glue:GetUserDefinedFunction
    - elasticmapreduce:DeleteRepository
    - comprehend:DetectDominantLanguage
    - appfabric:GetAppAuthorization
    - codeguru-profiler:ConfigureAgent
    - elasticbeanstalk:AssociateEnvironmentOperationsRole
    - transcribe:ListMedicalTranscriptionJobs
    - scheduler:CreateScheduleGroup
    - sagemaker-mlflow:UpdateExperiment
    - batch:DescribeSchedulingPolicies
    - sagemaker:DescribeTrial
    - storagegateway:CreateCachediSCSIVolume
    - iot:DeleteCertificate
    - qbusiness:ListUserLicenses
    - redshift-serverless:PutResourcePolicy
    - backup-storage:GetChunk
    - s3express:CreateBucket
    - thinclient:UpdateSoftwareSet
    - aoss:BatchGetVpcEndpoint
    - vpc-lattice:DeleteAuthPolicy
    - serverlessrepo:GetApplication
    - iotfleetwise:GenerateCommandPayload
    - guardduty:DisableOrganizationAdminAccount
    - lex:ListTestExecutions
    - globalaccelerator:TagResource
    - mobiletargeting:UpdateJourney
    - datapipeline:EvaluateExpression
    - ec2:CreateReplaceRootVolumeTask
    - resiliencehub:ListAppVersions
    - lex:GetMigrations
    - athena:StopQueryExecution
    - mq:ListBrokers
    - codecatalyst:ListConnections
    - vendor-insights:AssociateDataSource
    - appflow:ResetConnectorMetadataCache
    - transfer:CreateUser
    - osis:ListTagsForResource
    - route53domains:DeleteDomain
    - workspaces-web:ListTagsForResource
    - directconnect:CreateInterconnect
    - personalize:PutActionInteractions
    - apptest:ListTestSuites
    - arc-zonal-shift:GetAutoshiftObserverNotificationStatus
    - states:GetActivityTask
    - glue:StartMLLabelingSetGenerationTaskRun
    - athena:GetCalculationExecution
    - codestar:ListTagsForProject
    - connect:StartOutboundChatContact

  deniedService:
    - kafka
    - apprunner
    - fis
    - sms-voice
    - quicksight
    - controltower
    - connect
    - groundstation
    - rds
    - comprehend
    - servicecatalog
    - personalize
    - lightsail
    - mgh
    - glacier
    - apigateway
    - ivs
    - lex
    - cognito-idp
    - backup
    - iot
    - autoscaling
    - guardduty
    - cur
    - ec2
    - ds
    - ec2
    - codewhisperer
    - profile
    - medialive
    - sms-voice
    - qldb
    - clouddirectory
    - route53-recovery-readiness
    - shield
    - cognito-sync
    - globalaccelerator
    - geo-maps
    - sagemaker
    - ec2
    - deeplens
    - lex
    - codewhisperer
    - identity-sync
    - sso
    - license-manager
    - rum
    - servicecatalog
    - cognito-idp
    - ses
    - chime
    - cloudfront
    - glue
    - elasticmapreduce
    - comprehend
    - appfabric
    - codeguru-profiler
    - elasticbeanstalk
    - transcribe
    - scheduler
    - sagemaker-mlflow
    - batch
    - sagemaker
    - storagegateway
    - iot
    - qbusiness
    - redshift-serverless
    - backup-storage
    - s3express
    - thinclient
    - aoss
    - vpc-lattice
    - serverlessrepo
    - iotfleetwise
    - guardduty
    - lex
    - globalaccelerator
    - mobiletargeting
    - datapipeline
    - ec2
    - resiliencehub
    - lex
    - athena
    - mq
    - codecatalyst
    - vendor-insights
    - appflow
    - transfer
    - osis
    - route53domains
    - workspaces-web
    - directconnect
    - personalize
    - apptest
    - arc-zonal-shift
    - states
    - glue
    - athena
    - codestar
    - connect

  bucketModificationActions:
    - s3:DeleteBucket
    - s3:DeleteBucketPolicy
    - s3:DeleteBucketWebsite
    - s3:DeleteStorageLensConfiguration
    - s3:DeleteStorageLensConfigurationTagging
    - s3:PutBucketAcl
    - s3:PutBucketCORS
    - s3:PutBucketLogging
    - s3:PutBucketNotification
    - s3:PutBucketObjectLockConfiguration
    - s3:PutBucketOwnershipControls
    - s3:PutBucketPolicy
    - s3:PutBucketPublicAccessBlock
    - s3:PutBucketRequestPayment
    - s3:PutBucketTagging
    - s3:PutBucketVersioning
    - s3:PutBucketWebsite
    - s3:PutEncryptionConfiguration
    - s3:PutIntelligentTieringConfiguration
    - s3:PutInventoryConfiguration
    - s3:PutMultiRegionAccessPointPolicy

  objectModificationActions:
    - s3:DeleteObject
    - s3:DeleteObjectTagging
    - s3:DeleteObjectVersion
    - s3:DeleteObjectVersionTagging
    - s3:PutObject
    - s3:PutObjectAcl
    - s3:PutObjectLegalHold
    - s3:PutObjectRetention
    - s3:PutObjectTagging
    - s3:PutObjectVersionAcl
    - s3:PutObjectVersionTagging

  allowedActionsOnSensitiveBuckets:
    - s3:GetBucketAcl
    - s3:GetBucketCORS
    - s3:GetBucketLocation
    - s3:GetBucketLogging
    - s3:GetBucketNotification
    - s3:GetBucketObjectLockConfiguration
    - s3:GetBucketOwnershipControls
    - s3:GetBucketPolicy
    - s3:GetBucketPolicyStatus
    - s3:GetBucketPublicAccessBlock
    - s3:GetBucketRequestPayment
    - s3:GetBucketTagging
    - s3:GetBucketVersioning
    - s3:GetBucketWebsite
    - s3:GetDataAccess
    - s3:GetEncryptionConfiguration
    - s3:GetIntelligentTieringConfiguration
    - s3:GetInventoryConfiguration
    - s3:GetJobTagging
    - s3:GetLifecycleConfiguration
    - s3:GetMetricsConfiguration
    - s3:GetMultiRegionAccessPoint
    - s3:GetMultiRegionAccessPointPolicy
    - s3:GetMultiRegionAccessPointPolicyStatus
    - s3:GetMultiRegionAccessPointRoutes
    - s3:GetObject
    - s3:GetObjectAcl
    - s3:GetObjectAttributes
    - s3:GetObjectLegalHold
    - s3:GetObjectRetention
    - s3:GetObjectTagging
    - s3:GetObjectTorrent
    - s3:GetObjectVersion
    - s3:GetObjectVersionAcl
    - s3:GetObjectVersionAttributes
    - s3:GetObjectVersionForReplication
    - s3:GetObjectVersionTagging
    - s3:GetObjectVersionTorrent
    - s3:GetReplicationConfiguration
    - s3:GetStorageLensConfiguration
    - s3:GetStorageLensConfigurationTagging
    - s3:GetStorageLensDashboard
    - s3:GetStorageLensGroup
    - s3:ListAccessGrants
    - s3:ListAccessGrantsInstances
    - s3:ListAccessGrantsLocations
    - s3:ListAccessPoints
    - s3:ListAccessPointsForObjectLambda
    - s3:ListAllMyBuckets
    - s3:ListBucket
    - s3:ListBucketMultipartUploads
    - s3:ListBucketVersions
    - s3:ListCallerAccessGrants
    - s3:ListJobs
    - s3:ListMultiRegionAccessPoints
    - s3:ListMultipartUploadParts
    - s3:ListStorageLensConfigurations
    - s3:ListStorageLensGroups
    - s3:ListTagsForResource
    - s3:DescribeJob

  allowedActions:
    - s3:AbortMultipartUpload
    - s3:AssociateAccessGrantsIdentityCenter
    - s3:BypassGovernanceRetention
    - s3:CreateAccessGrant
    - s3:CreateAccessGrantsInstance
    - s3:CreateAccessGrantsLocation
    - s3:CreateAccessPoint
    - s3:CreateAccessPointForObjectLambda
    - s3:CreateBucket
    - s3:CreateJob
    - s3:CreateMultiRegionAccessPoint
    - s3:CreateStorageLensGroup
    - s3:DeleteAccessGrant
    - s3:DeleteAccessGrantsInstance
    - s3:DeleteAccessGrantsInstanceResourcePolicy
    - s3:DeleteAccessGrantsLocation
    - s3:DeleteAccessPoint
    - s3:DeleteAccessPointForObjectLambda
    - s3:DeleteAccessPointPolicy
    - s3:DeleteAccessPointPolicyForObjectLambda
    - s3:DeleteBucket
    - s3:DeleteBucketPolicy
    - s3:DeleteBucketWebsite
    - s3:DeleteJobTagging
    - s3:DeleteMultiRegionAccessPoint
    - s3:DeleteObject
    - s3:DeleteObjectTagging
    - s3:DeleteObjectVersion
    - s3:DeleteObjectVersionTagging
    - s3:DeleteStorageLensConfiguration
    - s3:DeleteStorageLensConfigurationTagging
    - s3:DeleteStorageLensGroup
    - s3:DescribeJob
    - s3:DescribeMultiRegionAccessPointOperation
    - s3:DissociateAccessGrantsIdentityCenter
    - s3:GetAccelerateConfiguration
    - s3:GetAccessGrant
    - s3:GetAccessGrantsInstance
    - s3:GetAccessGrantsInstanceForPrefix
    - s3:GetAccessGrantsInstanceResourcePolicy
    - s3:GetAccessGrantsLocation
    - s3:GetAccessPoint
    - s3:GetAccessPointConfigurationForObjectLambda
    - s3:GetAccessPointForObjectLambda
    - s3:GetAccessPointPolicy
    - s3:GetAccessPointPolicyForObjectLambda
    - s3:GetAccessPointPolicyStatus
    - s3:GetAccessPointPolicyStatusForObjectLambda
    - s3:GetAccountPublicAccessBlock
    - s3:GetAnalyticsConfiguration
    - s3:GetBucketAcl
    - s3:GetBucketCORS
    - s3:GetBucketLocation
    - s3:GetBucketLogging
    - s3:GetBucketNotification
    - s3:GetBucketObjectLockConfiguration
    - s3:GetBucketOwnershipControls
    - s3:GetBucketPolicy
    - s3:GetBucketPolicyStatus
    - s3:GetBucketPublicAccessBlock
    - s3:GetBucketRequestPayment
    - s3:GetBucketTagging
    - s3:GetBucketVersioning
    - s3:GetBucketWebsite
    - s3:GetDataAccess
    - s3:GetEncryptionConfiguration
    - s3:GetIntelligentTieringConfiguration
    - s3:GetInventoryConfiguration
    - s3:GetJobTagging
    - s3:GetLifecycleConfiguration
    - s3:GetMetricsConfiguration
    - s3:GetMultiRegionAccessPoint
    - s3:GetMultiRegionAccessPointPolicy
    - s3:GetMultiRegionAccessPointPolicyStatus
    - s3:GetMultiRegionAccessPointRoutes
    - s3:GetObject
    - s3:GetObjectAcl
    - s3:GetObjectAttributes
    - s3:GetObjectLegalHold
    - s3:GetObjectRetention
    - s3:GetObjectTagging
    - s3:GetObjectTorrent
    - s3:GetObjectVersion
    - s3:GetObjectVersionAcl
    - s3:GetObjectVersionAttributes
    - s3:GetObjectVersionForReplication
    - s3:GetObjectVersionTagging
    - s3:GetObjectVersionTorrent
    - s3:GetReplicationConfiguration
    - s3:GetStorageLensConfiguration
    - s3:GetStorageLensConfigurationTagging
    - s3:GetStorageLensDashboard
    - s3:GetStorageLensGroup
    - s3:InitiateReplication
    - s3:ListAccessGrants
    - s3:ListAccessGrantsInstances
    - s3:ListAccessGrantsLocations
    - s3:ListAccessPoints
    - s3:ListAccessPointsForObjectLambda
    - s3:ListAllMyBuckets
    - s3:ListBucket
    - s3:ListBucketMultipartUploads
    - s3:ListBucketVersions
    - s3:ListCallerAccessGrants
    - s3:ListJobs
    - s3:ListMultiRegionAccessPoints
    - s3:ListMultipartUploadParts
    - s3:ListStorageLensConfigurations
    - s3:ListStorageLensGroups
    - s3:ListTagsForResource
    - s3:ObjectOwnerOverrideToBucketOwner
    - s3:PauseReplication
    - s3:PutAccelerateConfiguration
    - s3:PutAccessGrantsInstanceResourcePolicy
    - s3:PutAccessPointConfigurationForObjectLambda
    - s3:PutAccessPointPolicy
    - s3:PutAccessPointPolicyForObjectLambda
    - s3:PutAccessPointPublicAccessBlock
    - s3:PutAccountPublicAccessBlock
    - s3:PutAnalyticsConfiguration
    - s3:PutBucketAcl
    - s3:PutBucketCORS
    - s3:PutBucketLogging
    - s3:PutBucketNotification
    - s3:PutBucketObjectLockConfiguration
    - s3:PutBucketOwnershipControls
    - s3:PutBucketPolicy
    - s3:PutBucketPublicAccessBlock
    - s3:PutBucketRequestPayment
    - s3:PutBucketTagging
    - s3:PutBucketVersioning
    - s3:PutBucketWebsite
    - s3:PutEncryptionConfiguration
    - s3:PutIntelligentTieringConfiguration
    - s3:PutInventoryConfiguration
    - s3:PutJobTagging
    - s3:PutLifecycleConfiguration
    - s3:PutMetricsConfiguration
    - s3:PutMultiRegionAccessPointPolicy
    - s3:PutObject
    - s3:PutObjectAcl
    - s3:PutObjectLegalHold
    - s3:PutObjectRetention
    - s3:PutObjectTagging
    - s3:PutObjectVersionAcl
    - s3:PutObjectVersionTagging
    - s3:PutReplicationConfiguration
    - s3:PutStorageLensConfiguration
    - s3:PutStorageLensConfigurationTagging
    - s3:ReplicateDelete
    - s3:ReplicateObject
    - s3:ReplicateTags
    - s3:RestoreObject
    - s3:SubmitMultiRegionAccessPointRoutes
    - s3:TagResource
    - s3:UntagResource
    - s3:UpdateAccessGrantsLocation
    - s3:UpdateJobPriority
    - s3:UpdateJobStatus
    - s3:UpdateStorageLensGroup
